import type { MetricDef, DimensionDef, MetricDimensionRelation, LensDef } from './types';

// ── Core Dimensions ───────────────────────────────────────────────

export const CORE_DIMENSIONS: Omit<DimensionDef, 'isActive'>[] = [
  {
    slug: 'date',
    displayName: 'Date',
    description: 'Business date of the transaction',
    domain: 'core',
    category: 'time',
    sqlExpression: 'business_date',
    sqlTable: 'rm_daily_sales',
    sqlDataType: 'date',
    isTimeDimension: true,
    timeGranularities: ['day', 'week', 'month', 'quarter', 'year'],
    aliases: ['day', 'when', 'period', 'time', 'business date'],
    examplePhrases: ['today', 'yesterday', 'last week', 'last month', 'this year'],
  },
  {
    slug: 'location',
    displayName: 'Location',
    description: 'Store or outlet location',
    domain: 'core',
    category: 'geography',
    sqlExpression: 'location_id',
    sqlTable: 'rm_daily_sales',
    sqlDataType: 'text',
    isTimeDimension: false,
    lookupTable: 'locations',
    lookupKeyColumn: 'id',
    lookupLabelColumn: 'name',
    aliases: ['store', 'outlet', 'branch', 'site'],
    examplePhrases: ['downtown location', 'all stores', 'main branch'],
  },
  {
    slug: 'item',
    displayName: 'Item',
    description: 'Product or menu item name',
    domain: 'core',
    category: 'product',
    sqlExpression: 'catalog_item_name',
    sqlTable: 'rm_item_sales',
    sqlDataType: 'text',
    isTimeDimension: false,
    aliases: ['product', 'menu item', 'sku', 'item name'],
    examplePhrases: ['burger', 'top products', 'best sellers', 'top selling items'],
  },
  {
    slug: 'category',
    displayName: 'Category',
    description: 'Product category or department name',
    domain: 'core',
    category: 'product',
    sqlExpression: 'category_name',
    sqlTable: 'rm_item_sales',
    sqlDataType: 'text',
    isTimeDimension: false,
    aliases: ['department', 'product category', 'menu category', 'item category', 'group'],
    examplePhrases: ['by category', 'food vs drinks', 'top categories', 'sales by department'],
  },
  {
    slug: 'week',
    displayName: 'Week',
    description: 'ISO week number',
    domain: 'core',
    category: 'time',
    sqlExpression: "DATE_TRUNC('week', business_date)",
    sqlTable: 'rm_daily_sales',
    sqlDataType: 'date',
    hierarchyParent: 'date',
    hierarchyLevel: 1,
    isTimeDimension: true,
    timeGranularities: ['week'],
    aliases: ['weekly'],
    examplePhrases: ['this week', 'last week', 'week of'],
  },
  {
    slug: 'month',
    displayName: 'Month',
    description: 'Calendar month',
    domain: 'core',
    category: 'time',
    sqlExpression: "DATE_TRUNC('month', business_date)",
    sqlTable: 'rm_daily_sales',
    sqlDataType: 'date',
    hierarchyParent: 'week',
    hierarchyLevel: 2,
    isTimeDimension: true,
    timeGranularities: ['month'],
    aliases: ['monthly'],
    examplePhrases: ['this month', 'last month', 'January'],
  },
  // ── Inventory dimensions ──────────────────────────────────────
  {
    slug: 'inventory_item',
    displayName: 'Inventory Item',
    description: 'Product name in inventory',
    domain: 'inventory',
    category: 'product',
    sqlExpression: 'item_name',
    sqlTable: 'rm_inventory_on_hand',
    sqlDataType: 'text',
    isTimeDimension: false,
    aliases: ['stock item', 'product', 'inventory product'],
    examplePhrases: ['which items', 'stock levels by item', 'low stock items'],
  },
  {
    slug: 'inventory_location',
    displayName: 'Inventory Location',
    description: 'Location for inventory snapshot',
    domain: 'inventory',
    category: 'geography',
    sqlExpression: 'location_id',
    sqlTable: 'rm_inventory_on_hand',
    sqlDataType: 'text',
    isTimeDimension: false,
    lookupTable: 'locations',
    lookupKeyColumn: 'id',
    lookupLabelColumn: 'name',
    aliases: ['warehouse', 'store', 'location'],
    examplePhrases: ['by location', 'at downtown', 'each store'],
  },
  // ── Customer dimensions ───────────────────────────────────────
  {
    slug: 'customer',
    displayName: 'Customer',
    description: 'Customer name',
    domain: 'customer',
    category: 'customer',
    sqlExpression: 'customer_name',
    sqlTable: 'rm_customer_activity',
    sqlDataType: 'text',
    isTimeDimension: false,
    aliases: ['guest', 'member', 'patron', 'client'],
    examplePhrases: ['top customers', 'best customers', 'most frequent visitors'],
  },
];

// ── Core Metrics ──────────────────────────────────────────────────

export const CORE_METRICS: Omit<MetricDef, 'isActive' | 'isExperimental'>[] = [
  // ── rm_daily_sales metrics ────────────────────────────────────
  {
    slug: 'net_sales',
    displayName: 'Net Sales',
    description: 'Total net sales revenue in dollars (after voids and refunds). Pre-aggregated daily per location from rm_daily_sales. Group by date and/or location.',
    domain: 'core',
    category: 'revenue',
    sqlExpression: 'SUM(net_sales)',
    sqlTable: 'rm_daily_sales',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['revenue', 'sales', 'total sales', 'gross revenue', 'income'],
    examplePhrases: [
      'how much did we sell',
      'what were our sales',
      'show me revenue',
      'total sales yesterday',
    ],
    relatedMetrics: ['gross_sales', 'order_count', 'avg_order_value'],
  },
  {
    slug: 'gross_sales',
    displayName: 'Gross Sales',
    description: 'Total gross sales in dollars before voids and returns. Pre-aggregated daily per location.',
    domain: 'core',
    category: 'revenue',
    sqlExpression: 'SUM(gross_sales)',
    sqlTable: 'rm_daily_sales',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['gross revenue', 'pre-void sales'],
    examplePhrases: ['gross sales', 'before voids'],
    relatedMetrics: ['net_sales', 'void_total'],
  },
  {
    slug: 'order_count',
    displayName: 'Order Count',
    description: 'Number of completed orders (placed + paid, excludes voided). Pre-aggregated daily per location.',
    domain: 'core',
    category: 'volume',
    sqlExpression: 'SUM(order_count)',
    sqlTable: 'rm_daily_sales',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'orders',
    higherIsBetter: true,
    aliases: ['transactions', 'orders', 'ticket count', 'covers'],
    examplePhrases: [
      'how many orders',
      'number of transactions',
      'ticket count',
      'how many customers served',
    ],
    relatedMetrics: ['net_sales', 'avg_order_value'],
  },
  {
    slug: 'avg_order_value',
    displayName: 'Average Order Value',
    description: 'Average revenue per completed order (net_sales / order_count). Computed ratio — not a SUM. Incompatible with items_sold.',
    domain: 'core',
    category: 'efficiency',
    sqlExpression: 'SUM(net_sales) / NULLIF(SUM(order_count), 0)',
    sqlTable: 'rm_daily_sales',
    sqlAggregation: 'custom',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['aov', 'check average', 'average ticket', 'average check'],
    examplePhrases: [
      'what is our average ticket',
      'average order size',
      'check average',
      'average spend per customer',
    ],
    relatedMetrics: ['net_sales', 'order_count'],
    incompatibleWith: ['items_sold'],
  },
  {
    slug: 'void_count',
    displayName: 'Void Count',
    description: 'Number of voided orders. Pre-aggregated daily per location.',
    domain: 'core',
    category: 'operations',
    sqlExpression: 'SUM(void_count)',
    sqlTable: 'rm_daily_sales',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    higherIsBetter: false,
    aliases: ['voids', 'cancellations', 'cancelled orders'],
    examplePhrases: ['how many voids', 'cancelled orders', 'void rate'],
    relatedMetrics: ['void_total', 'order_count'],
  },
  {
    slug: 'void_total',
    displayName: 'Void Amount',
    description: 'Total dollar value of voided orders. Pre-aggregated daily per location.',
    domain: 'core',
    category: 'operations',
    sqlExpression: 'SUM(void_total)',
    sqlTable: 'rm_daily_sales',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: false,
    aliases: ['voids amount', 'voided sales'],
    examplePhrases: ['void total', 'how much was voided'],
    relatedMetrics: ['void_count', 'net_sales'],
  },
  {
    slug: 'discount_total',
    displayName: 'Discount Total',
    description: 'Total discount amount in dollars applied to orders. Pre-aggregated daily per location.',
    domain: 'core',
    category: 'revenue',
    sqlExpression: 'SUM(discount_total)',
    sqlTable: 'rm_daily_sales',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: false,
    aliases: ['discounts', 'promo amount', 'discount amount'],
    examplePhrases: ['how much did we discount', 'discount total', 'promo spend'],
    relatedMetrics: ['net_sales', 'gross_sales'],
  },
  {
    slug: 'tax_total',
    displayName: 'Tax Collected',
    description: 'Total tax amount collected in dollars. Pre-aggregated daily per location.',
    domain: 'core',
    category: 'revenue',
    sqlExpression: 'SUM(tax_total)',
    sqlTable: 'rm_daily_sales',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: null,
    aliases: ['taxes', 'tax collected', 'sales tax'],
    examplePhrases: ['how much tax collected', 'tax total', 'taxes today'],
    relatedMetrics: ['net_sales', 'gross_sales'],
  },
  {
    slug: 'tender_cash',
    displayName: 'Cash Payments',
    description: 'Total cash tender amount received in dollars. Pre-aggregated daily per location.',
    domain: 'core',
    category: 'payments',
    sqlExpression: 'SUM(tender_cash)',
    sqlTable: 'rm_daily_sales',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: null,
    aliases: ['cash', 'cash received', 'cash payments'],
    examplePhrases: ['how much cash', 'cash payments today', 'cash vs card'],
    relatedMetrics: ['tender_card', 'net_sales'],
  },
  {
    slug: 'tender_card',
    displayName: 'Card Payments',
    description: 'Total card/credit tender amount received in dollars. Pre-aggregated daily per location.',
    domain: 'core',
    category: 'payments',
    sqlExpression: 'SUM(tender_card)',
    sqlTable: 'rm_daily_sales',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: null,
    aliases: ['card', 'credit card', 'card payments'],
    examplePhrases: ['how much on card', 'card payments today', 'credit card total'],
    relatedMetrics: ['tender_cash', 'net_sales'],
  },
  // ── rm_item_sales metrics (FIXED: use actual column names) ────
  {
    slug: 'items_sold',
    displayName: 'Items Sold',
    description: 'Total quantity of items sold. From rm_item_sales — can group by item, category, date, location. Incompatible with avg_order_value.',
    domain: 'core',
    category: 'volume',
    sqlExpression: 'SUM(quantity_sold)',
    sqlTable: 'rm_item_sales',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'units',
    higherIsBetter: true,
    aliases: ['units sold', 'quantity', 'items', 'qty', 'top selling'],
    examplePhrases: ['how many items sold', 'top selling items', 'quantity sold', 'best sellers'],
    relatedMetrics: ['net_sales', 'item_revenue'],
    incompatibleWith: ['avg_order_value'],
  },
  {
    slug: 'item_revenue',
    displayName: 'Item Revenue',
    description: 'Gross revenue in dollars attributed to specific items. From rm_item_sales — group by item or category.',
    domain: 'core',
    category: 'revenue',
    sqlExpression: 'SUM(gross_revenue)',
    sqlTable: 'rm_item_sales',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['item sales', 'product revenue', 'item gross'],
    examplePhrases: ['revenue by item', 'top items by revenue', 'highest earning items'],
    relatedMetrics: ['items_sold'],
  },
  {
    slug: 'items_voided',
    displayName: 'Items Voided',
    description: 'Quantity of items voided. From rm_item_sales — group by item or category.',
    domain: 'core',
    category: 'operations',
    sqlExpression: 'SUM(quantity_voided)',
    sqlTable: 'rm_item_sales',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'units',
    higherIsBetter: false,
    aliases: ['voided items', 'quantity voided'],
    examplePhrases: ['voided items', 'which items got voided'],
    relatedMetrics: ['items_sold', 'void_count'],
  },
  // ── rm_inventory_on_hand metrics (snapshot — no date dimension) ──
  {
    slug: 'on_hand_qty',
    displayName: 'On Hand Quantity',
    description: 'Current units in stock (SNAPSHOT — point-in-time, NOT time-series). Do NOT add date dimension or date range. From rm_inventory_on_hand.',
    domain: 'inventory',
    category: 'inventory',
    sqlExpression: 'SUM(on_hand)',
    sqlTable: 'rm_inventory_on_hand',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'units',
    higherIsBetter: true,
    aliases: ['stock', 'inventory', 'on hand', 'stock level', 'quantity on hand'],
    examplePhrases: ['how much stock do we have', 'inventory levels', 'what is on hand', 'stock quantity'],
    relatedMetrics: ['low_stock_count'],
  },
  {
    slug: 'low_stock_count',
    displayName: 'Low Stock Items',
    description: 'Number of items currently below their reorder threshold (SNAPSHOT — no date dimension). From rm_inventory_on_hand.',
    domain: 'inventory',
    category: 'inventory',
    sqlExpression: 'COUNT(*) FILTER (WHERE is_below_threshold = true)',
    sqlTable: 'rm_inventory_on_hand',
    sqlAggregation: 'custom',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'items',
    higherIsBetter: false,
    aliases: ['low stock', 'reorder needed', 'below threshold', 'out of stock'],
    examplePhrases: ['how many items are low stock', 'what needs reordering', 'low stock alert'],
    relatedMetrics: ['on_hand_qty', 'inventory_item_count'],
  },
  {
    slug: 'inventory_item_count',
    displayName: 'Inventory Item Count',
    description: 'Number of distinct inventory items tracked (SNAPSHOT — no date dimension). From rm_inventory_on_hand.',
    domain: 'inventory',
    category: 'inventory',
    sqlExpression: 'COUNT(*)',
    sqlTable: 'rm_inventory_on_hand',
    sqlAggregation: 'count',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'items',
    higherIsBetter: null,
    aliases: ['product count', 'item count', 'SKU count'],
    examplePhrases: ['how many items in inventory', 'total products tracked'],
    relatedMetrics: ['on_hand_qty', 'low_stock_count'],
  },
  // ── rm_customer_activity metrics (running total — no date dimension) ──
  {
    slug: 'customer_count',
    displayName: 'Customer Count',
    description: 'Total unique customers (RUNNING TOTAL, not time-series). Do NOT add date dimension. From rm_customer_activity.',
    domain: 'customer',
    category: 'customer',
    sqlExpression: 'COUNT(*)',
    sqlTable: 'rm_customer_activity',
    sqlAggregation: 'count',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'customers',
    higherIsBetter: true,
    aliases: ['total customers', 'guest count', 'client count'],
    examplePhrases: ['how many customers', 'total customers', 'customer base size'],
    relatedMetrics: ['total_customer_visits', 'total_customer_spend'],
  },
  {
    slug: 'total_customer_visits',
    displayName: 'Total Customer Visits',
    description: 'Sum of all customer visits across all customers (RUNNING TOTAL, not time-series). From rm_customer_activity.',
    domain: 'customer',
    category: 'customer',
    sqlExpression: 'SUM(total_visits)',
    sqlTable: 'rm_customer_activity',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'visits',
    higherIsBetter: true,
    aliases: ['visits', 'total visits', 'foot traffic'],
    examplePhrases: ['total visits', 'customer visits', 'who visits most'],
    relatedMetrics: ['customer_count', 'total_customer_spend'],
  },
  {
    slug: 'total_customer_spend',
    displayName: 'Total Customer Spend',
    description: 'Sum of all customer lifetime spend in dollars (RUNNING TOTAL). Group by customer dimension for top spenders. From rm_customer_activity.',
    domain: 'customer',
    category: 'customer',
    sqlExpression: 'SUM(total_spend)',
    sqlTable: 'rm_customer_activity',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['lifetime spend', 'customer revenue', 'total spend'],
    examplePhrases: ['total customer spend', 'who spends the most', 'top spenders', 'best customers'],
    relatedMetrics: ['customer_count', 'total_customer_visits', 'avg_customer_spend'],
  },
  {
    slug: 'avg_customer_spend',
    displayName: 'Avg Customer Spend',
    description: 'Average lifetime spend per customer in dollars (RUNNING TOTAL, not time-series). From rm_customer_activity.',
    domain: 'customer',
    category: 'customer',
    sqlExpression: 'SUM(total_spend) / NULLIF(COUNT(*), 0)',
    sqlTable: 'rm_customer_activity',
    sqlAggregation: 'custom',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['average spend', 'spend per customer', 'average CLV'],
    examplePhrases: ['average spend per customer', 'average customer value', 'CLV'],
    relatedMetrics: ['total_customer_spend', 'customer_count'],
  },
  {
    slug: 'avg_customer_visits',
    displayName: 'Avg Customer Visits',
    description: 'Average number of visits per customer (RUNNING TOTAL, not time-series). From rm_customer_activity.',
    domain: 'customer',
    category: 'customer',
    sqlExpression: 'SUM(total_visits) / NULLIF(COUNT(*), 0)',
    sqlTable: 'rm_customer_activity',
    sqlAggregation: 'custom',
    dataType: 'number',
    formatPattern: '0.0',
    unit: 'visits',
    higherIsBetter: true,
    aliases: ['average visits', 'visits per customer', 'visit frequency'],
    examplePhrases: ['how often do customers visit', 'average visits per customer', 'visit frequency'],
    relatedMetrics: ['total_customer_visits', 'customer_count'],
  },
];

// ── Golf Dimensions ───────────────────────────────────────────────

export const GOLF_DIMENSIONS: Omit<DimensionDef, 'isActive'>[] = [
  {
    slug: 'golf_course',
    displayName: 'Course',
    description: 'Golf course',
    domain: 'golf',
    category: 'golf',
    sqlExpression: 'course_id',
    sqlTable: 'rm_golf_revenue_daily',
    sqlDataType: 'text',
    isTimeDimension: false,
    lookupTable: 'courses',
    lookupKeyColumn: 'id',
    lookupLabelColumn: 'name',
    aliases: ['course', 'track'],
    examplePhrases: ['course 1', 'the back nine', 'championship course'],
  },
  {
    slug: 'booking_channel',
    displayName: 'Booking Channel',
    description: 'How the round was booked',
    domain: 'golf',
    category: 'golf',
    sqlExpression: 'channel',
    sqlTable: 'rm_golf_channel_daily',
    sqlDataType: 'text',
    isTimeDimension: false,
    aliases: ['channel', 'source', 'booking source'],
    exampleValues: ['walk_in', 'online', 'phone', 'third_party', 'member'],
    examplePhrases: ['online bookings', 'walk-ins', 'phone reservations'],
  },
  {
    slug: 'daypart',
    displayName: 'Daypart',
    description: 'Time segment of day (morning, afternoon, twilight)',
    domain: 'golf',
    category: 'golf',
    sqlExpression: "CASE WHEN hour_of_day < 12 THEN 'morning' WHEN hour_of_day < 16 THEN 'afternoon' ELSE 'twilight' END",
    sqlTable: 'rm_golf_hourly_distribution',
    sqlDataType: 'text',
    isTimeDimension: false,
    aliases: ['time of day', 'shift', 'session'],
    exampleValues: ['morning', 'afternoon', 'twilight'],
    examplePhrases: ['morning rounds', 'twilight rates', 'afternoon tee times'],
  },
  {
    slug: 'player_type',
    displayName: 'Player Type',
    description: 'Member, guest, or resort guest',
    domain: 'golf',
    category: 'golf',
    sqlExpression: 'booking_type',
    sqlTable: 'rm_golf_tee_time_fact',
    sqlDataType: 'text',
    isTimeDimension: false,
    aliases: ['member type', 'customer type', 'guest type'],
    exampleValues: ['member', 'guest', 'resort_guest', 'comp'],
    examplePhrases: ['member rounds', 'guest rounds', 'resort guests'],
  },
  {
    slug: 'holes',
    displayName: 'Holes',
    description: 'Number of holes played (9 or 18)',
    domain: 'golf',
    category: 'golf',
    sqlExpression: 'holes',
    sqlTable: 'rm_golf_tee_time_fact',
    sqlDataType: 'integer',
    isTimeDimension: false,
    aliases: ['9 holes', '18 holes', 'front nine', 'back nine'],
    exampleValues: ['9', '18'],
    examplePhrases: ['9-hole rounds', '18-hole games', 'front nine only'],
  },
  {
    slug: 'day_of_week',
    displayName: 'Day of Week',
    description: 'Day of the week (Monday–Sunday) for pattern analysis',
    domain: 'golf',
    category: 'time',
    sqlExpression: "TO_CHAR(business_date, 'Day')",
    sqlTable: 'rm_golf_revenue_daily',
    sqlDataType: 'text',
    isTimeDimension: false,
    aliases: ['weekday', 'day', 'dow'],
    exampleValues: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
    examplePhrases: ['weekday vs weekend', 'busiest day', 'Saturday performance'],
  },
];

// ── Golf Metrics ──────────────────────────────────────────────────

export const GOLF_METRICS: Omit<MetricDef, 'isActive' | 'isExperimental'>[] = [
  {
    slug: 'rounds_played',
    displayName: 'Rounds Played',
    description: 'Number of rounds of golf completed',
    domain: 'golf',
    category: 'volume',
    sqlExpression: 'SUM(rounds_played)',
    sqlTable: 'rm_golf_revenue_daily',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'rounds',
    higherIsBetter: true,
    aliases: ['rounds', 'games', 'tee times played', 'round count'],
    examplePhrases: [
      'how many rounds',
      'rounds played today',
      'tee time count',
      'how busy were we',
    ],
    relatedMetrics: ['green_fee_revenue', 'utilization_rate'],
  },
  {
    slug: 'green_fee_revenue',
    displayName: 'Green Fee Revenue',
    description: 'Revenue from green fees (excludes cart, F&B)',
    domain: 'golf',
    category: 'revenue',
    sqlExpression: 'SUM(green_fee_revenue)',
    sqlTable: 'rm_golf_revenue_daily',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['green fees', 'greens revenue', 'tee time revenue'],
    examplePhrases: ['green fee revenue', 'how much from green fees'],
    relatedMetrics: ['rounds_played', 'revenue_per_round'],
  },
  {
    slug: 'revenue_per_round',
    displayName: 'Revenue Per Round',
    description: 'Average green fee revenue per round played',
    domain: 'golf',
    category: 'efficiency',
    sqlExpression: 'SUM(green_fee_revenue) / NULLIF(SUM(rounds_played), 0)',
    sqlTable: 'rm_golf_revenue_daily',
    sqlAggregation: 'custom',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['yield per round', 'average green fee', 'rev per round'],
    examplePhrases: ['average revenue per round', 'yield', 'how much per round'],
    relatedMetrics: ['green_fee_revenue', 'rounds_played'],
  },
  {
    slug: 'utilization_rate',
    displayName: 'Utilization Rate',
    description: 'Percentage of available tee times that were played',
    domain: 'golf',
    category: 'efficiency',
    sqlExpression: 'SUM(slots_booked)::NUMERIC / NULLIF(SUM(slots_available), 0) * 100',
    sqlTable: 'rm_golf_tee_time_demand',
    sqlAggregation: 'custom',
    dataType: 'percent',
    formatPattern: '0.0%',
    higherIsBetter: true,
    aliases: ['occupancy', 'fill rate', 'tee sheet utilization'],
    examplePhrases: [
      'utilization rate',
      'how full were we',
      'tee sheet occupancy',
      'fill rate',
    ],
    relatedMetrics: ['rounds_played'],
    requiresDimensions: ['date'],
  },
  {
    slug: 'avg_pace_of_play',
    displayName: 'Avg Pace of Play',
    description: 'Average round duration in minutes',
    domain: 'golf',
    category: 'operations',
    sqlExpression: 'AVG(avg_pace_minutes)',
    sqlTable: 'rm_golf_pace_daily',
    sqlAggregation: 'avg',
    dataType: 'duration',
    formatPattern: '0,0',
    unit: 'minutes',
    higherIsBetter: false,
    aliases: ['pace of play', 'round time', 'average pace', 'round duration'],
    examplePhrases: [
      'average pace of play',
      'how long do rounds take',
      'round time',
      'pace tracking',
    ],
    relatedMetrics: ['rounds_played'],
  },
  {
    slug: 'total_golf_revenue',
    displayName: 'Total Golf Revenue',
    description: 'All golf revenue: green fees + cart + instruction + other',
    domain: 'golf',
    category: 'revenue',
    sqlExpression: 'SUM(total_revenue)',
    sqlTable: 'rm_golf_revenue_daily',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['golf revenue', 'total revenue', 'golf income'],
    examplePhrases: ['total golf revenue', 'all golf income', 'how much golf revenue'],
    relatedMetrics: ['green_fee_revenue', 'rounds_played'],
  },
  {
    slug: 'cart_revenue',
    displayName: 'Cart Revenue',
    description: 'Revenue from golf cart rentals',
    domain: 'golf',
    category: 'revenue',
    sqlExpression: 'SUM(cart_fee_revenue)',
    sqlTable: 'rm_golf_revenue_daily',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['cart rental', 'cart income', 'golf cart revenue'],
    examplePhrases: ['cart revenue', 'how much from cart rentals', 'cart income'],
    relatedMetrics: ['total_golf_revenue', 'rounds_played'],
  },
  {
    slug: 'available_tee_times',
    displayName: 'Available Tee Times',
    description: 'Total number of available tee time slots',
    domain: 'golf',
    category: 'operations',
    sqlExpression: 'SUM(slots_available)',
    sqlTable: 'rm_golf_tee_time_demand',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'slots',
    higherIsBetter: null,
    aliases: ['capacity', 'total slots', 'tee time capacity'],
    examplePhrases: ['how many tee times available', 'total capacity', 'open slots'],
    relatedMetrics: ['rounds_played', 'utilization_rate'],
  },
];

// ── Core Metric–Dimension relations ───────────────────────────────

export const CORE_METRIC_DIMENSIONS: MetricDimensionRelation[] = [
  // net_sales
  { metricSlug: 'net_sales', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'net_sales', dimensionSlug: 'location', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'net_sales', dimensionSlug: 'week', isRequired: false, isDefault: false, sortOrder: 2 },
  { metricSlug: 'net_sales', dimensionSlug: 'month', isRequired: false, isDefault: false, sortOrder: 3 },
  // gross_sales
  { metricSlug: 'gross_sales', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'gross_sales', dimensionSlug: 'location', isRequired: false, isDefault: false, sortOrder: 1 },
  // order_count
  { metricSlug: 'order_count', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'order_count', dimensionSlug: 'location', isRequired: false, isDefault: false, sortOrder: 1 },
  // avg_order_value
  { metricSlug: 'avg_order_value', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'avg_order_value', dimensionSlug: 'location', isRequired: false, isDefault: false, sortOrder: 1 },
  // void_count & void_total
  { metricSlug: 'void_count', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'void_count', dimensionSlug: 'location', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'void_total', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'void_total', dimensionSlug: 'location', isRequired: false, isDefault: false, sortOrder: 1 },
  // discount_total
  { metricSlug: 'discount_total', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'discount_total', dimensionSlug: 'location', isRequired: false, isDefault: false, sortOrder: 1 },
  // tax_total
  { metricSlug: 'tax_total', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'tax_total', dimensionSlug: 'location', isRequired: false, isDefault: false, sortOrder: 1 },
  // tender_cash & tender_card
  { metricSlug: 'tender_cash', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'tender_cash', dimensionSlug: 'location', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'tender_card', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'tender_card', dimensionSlug: 'location', isRequired: false, isDefault: false, sortOrder: 1 },
  // items_sold (uses rm_item_sales)
  { metricSlug: 'items_sold', dimensionSlug: 'date', isRequired: false, isDefault: false, sortOrder: 0 },
  { metricSlug: 'items_sold', dimensionSlug: 'item', isRequired: false, isDefault: true, sortOrder: 1 },
  { metricSlug: 'items_sold', dimensionSlug: 'location', isRequired: false, isDefault: false, sortOrder: 2 },
  { metricSlug: 'items_sold', dimensionSlug: 'category', isRequired: false, isDefault: false, sortOrder: 3 },
  // item_revenue (uses rm_item_sales)
  { metricSlug: 'item_revenue', dimensionSlug: 'date', isRequired: false, isDefault: false, sortOrder: 0 },
  { metricSlug: 'item_revenue', dimensionSlug: 'item', isRequired: false, isDefault: true, sortOrder: 1 },
  { metricSlug: 'item_revenue', dimensionSlug: 'location', isRequired: false, isDefault: false, sortOrder: 2 },
  { metricSlug: 'item_revenue', dimensionSlug: 'category', isRequired: false, isDefault: false, sortOrder: 3 },
  // items_voided (uses rm_item_sales)
  { metricSlug: 'items_voided', dimensionSlug: 'date', isRequired: false, isDefault: false, sortOrder: 0 },
  { metricSlug: 'items_voided', dimensionSlug: 'item', isRequired: false, isDefault: true, sortOrder: 1 },
  { metricSlug: 'items_voided', dimensionSlug: 'location', isRequired: false, isDefault: false, sortOrder: 2 },
  { metricSlug: 'items_voided', dimensionSlug: 'category', isRequired: false, isDefault: false, sortOrder: 3 },
  // inventory metrics (snapshot — no date dimension)
  { metricSlug: 'on_hand_qty', dimensionSlug: 'inventory_item', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'on_hand_qty', dimensionSlug: 'inventory_location', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'low_stock_count', dimensionSlug: 'inventory_location', isRequired: false, isDefault: false, sortOrder: 0 },
  { metricSlug: 'inventory_item_count', dimensionSlug: 'inventory_location', isRequired: false, isDefault: false, sortOrder: 0 },
  // customer metrics (running total — no date dimension)
  { metricSlug: 'customer_count', dimensionSlug: 'customer', isRequired: false, isDefault: false, sortOrder: 0 },
  { metricSlug: 'total_customer_visits', dimensionSlug: 'customer', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'total_customer_spend', dimensionSlug: 'customer', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'avg_customer_spend', dimensionSlug: 'customer', isRequired: false, isDefault: false, sortOrder: 0 },
  { metricSlug: 'avg_customer_visits', dimensionSlug: 'customer', isRequired: false, isDefault: false, sortOrder: 0 },
];

// ── Golf Metric–Dimension relations ───────────────────────────────

export const GOLF_METRIC_DIMENSIONS: MetricDimensionRelation[] = [
  { metricSlug: 'rounds_played', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'rounds_played', dimensionSlug: 'golf_course', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'rounds_played', dimensionSlug: 'booking_channel', isRequired: false, isDefault: false, sortOrder: 2 },
  { metricSlug: 'rounds_played', dimensionSlug: 'daypart', isRequired: false, isDefault: false, sortOrder: 3 },
  { metricSlug: 'rounds_played', dimensionSlug: 'player_type', isRequired: false, isDefault: false, sortOrder: 4 },
  { metricSlug: 'green_fee_revenue', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'green_fee_revenue', dimensionSlug: 'golf_course', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'green_fee_revenue', dimensionSlug: 'booking_channel', isRequired: false, isDefault: false, sortOrder: 2 },
  { metricSlug: 'green_fee_revenue', dimensionSlug: 'player_type', isRequired: false, isDefault: false, sortOrder: 3 },
  { metricSlug: 'revenue_per_round', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'revenue_per_round', dimensionSlug: 'golf_course', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'revenue_per_round', dimensionSlug: 'booking_channel', isRequired: false, isDefault: false, sortOrder: 2 },
  { metricSlug: 'utilization_rate', dimensionSlug: 'date', isRequired: true, isDefault: true, sortOrder: 0 },
  { metricSlug: 'utilization_rate', dimensionSlug: 'golf_course', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'avg_pace_of_play', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'avg_pace_of_play', dimensionSlug: 'golf_course', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'total_golf_revenue', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'total_golf_revenue', dimensionSlug: 'golf_course', isRequired: false, isDefault: false, sortOrder: 1 },
  // cart_revenue
  { metricSlug: 'cart_revenue', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'cart_revenue', dimensionSlug: 'golf_course', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'cart_revenue', dimensionSlug: 'player_type', isRequired: false, isDefault: false, sortOrder: 2 },
  // available_tee_times
  { metricSlug: 'available_tee_times', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'available_tee_times', dimensionSlug: 'golf_course', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'available_tee_times', dimensionSlug: 'daypart', isRequired: false, isDefault: false, sortOrder: 2 },
  // day_of_week dimension relations
  { metricSlug: 'rounds_played', dimensionSlug: 'day_of_week', isRequired: false, isDefault: false, sortOrder: 5 },
  { metricSlug: 'green_fee_revenue', dimensionSlug: 'day_of_week', isRequired: false, isDefault: false, sortOrder: 4 },
  { metricSlug: 'total_golf_revenue', dimensionSlug: 'day_of_week', isRequired: false, isDefault: false, sortOrder: 2 },
  // holes dimension relations
  { metricSlug: 'rounds_played', dimensionSlug: 'holes', isRequired: false, isDefault: false, sortOrder: 6 },
  { metricSlug: 'green_fee_revenue', dimensionSlug: 'holes', isRequired: false, isDefault: false, sortOrder: 5 },
];

// ── System Lenses ─────────────────────────────────────────────────

export const SYSTEM_LENSES: Omit<LensDef, 'isActive'>[] = [
  {
    slug: 'core_sales',
    displayName: 'Sales & Revenue',
    description: 'Daily sales, order counts, revenue, discounts, taxes, and payment methods',
    domain: 'core',
    isSystem: true,
    allowedMetrics: ['net_sales', 'gross_sales', 'order_count', 'avg_order_value', 'void_count', 'void_total', 'discount_total', 'tax_total', 'tender_cash', 'tender_card'],
    allowedDimensions: ['date', 'location', 'week', 'month'],
    defaultMetrics: ['net_sales', 'order_count'],
    defaultDimensions: ['date'],
    exampleQuestions: [
      'How were sales yesterday?',
      'What is our revenue this week?',
      'How does today compare to last Tuesday?',
      'Which location had the most sales?',
      'How much did we discount?',
      'Cash vs card payments?',
    ],
    systemPromptFragment:
      'You are analyzing sales and revenue data. Key metrics: net_sales, order_count, avg_order_value, discount_total, tax_total, tender_cash, tender_card. Always include a date dimension unless asked otherwise.',
  },
  {
    slug: 'core_items',
    displayName: 'Item Performance',
    description: 'Item-level sales, quantities, and revenue — find top sellers and underperformers, analyze by category',
    domain: 'core',
    isSystem: true,
    allowedMetrics: ['items_sold', 'item_revenue', 'items_voided'],
    allowedDimensions: ['date', 'item', 'category', 'location', 'week', 'month'],
    defaultMetrics: ['items_sold', 'item_revenue'],
    defaultDimensions: ['item'],
    exampleQuestions: [
      'What are the top selling items?',
      'Which items bring in the most revenue?',
      'What are our best sellers this week?',
      'Show me items sold today',
      'Sales by category',
      'Which category sells the most?',
    ],
    systemPromptFragment:
      'You are analyzing item-level sales. Use items_sold for quantity and item_revenue for dollar amounts. Group by the item dimension to see per-product breakdown, or by the category dimension to see per-category breakdown. Default to sorting by items_sold or item_revenue descending with a limit of 20 for "top" queries.',
  },
  {
    slug: 'core_inventory',
    displayName: 'Inventory Status',
    description: 'Current stock levels, low-stock alerts, and inventory overview',
    domain: 'inventory',
    isSystem: true,
    allowedMetrics: ['on_hand_qty', 'low_stock_count', 'inventory_item_count'],
    allowedDimensions: ['inventory_item', 'inventory_location'],
    defaultMetrics: ['on_hand_qty'],
    defaultDimensions: ['inventory_item'],
    exampleQuestions: [
      'What is our inventory status?',
      'How many items are low stock?',
      'Stock levels by location',
      'What needs reordering?',
    ],
    systemPromptFragment:
      'You are analyzing current inventory status. This is SNAPSHOT data (not time-series) — do NOT include date dimensions or date ranges. Key metrics: on_hand_qty (stock level), low_stock_count (items below reorder point), inventory_item_count (total products tracked).',
  },
  {
    slug: 'core_customers',
    displayName: 'Customer Insights',
    description: 'Customer visit frequency, spend patterns, and top customers',
    domain: 'customer',
    isSystem: true,
    allowedMetrics: ['customer_count', 'total_customer_visits', 'total_customer_spend', 'avg_customer_spend', 'avg_customer_visits'],
    allowedDimensions: ['customer'],
    defaultMetrics: ['total_customer_spend', 'total_customer_visits'],
    defaultDimensions: ['customer'],
    exampleQuestions: [
      'Who are our best customers?',
      'How many customers do we have?',
      'Top spenders',
      'Average customer spend',
      'Most frequent visitors',
    ],
    systemPromptFragment:
      'You are analyzing customer engagement data. This is RUNNING TOTAL data (not time-series) — do NOT include date dimensions or date ranges. Key metrics: total_customer_spend (lifetime $), total_customer_visits (lifetime visits), customer_count, avg_customer_spend, avg_customer_visits. Group by customer dimension for "top" queries.',
  },
  {
    slug: 'golf_operations',
    displayName: 'Golf Operations',
    description: 'Rounds played, utilization, pace of play',
    domain: 'golf',
    isSystem: true,
    allowedMetrics: ['rounds_played', 'utilization_rate', 'avg_pace_of_play'],
    allowedDimensions: ['date', 'golf_course', 'booking_channel', 'daypart', 'player_type'],
    defaultMetrics: ['rounds_played', 'utilization_rate'],
    defaultDimensions: ['date'],
    exampleQuestions: [
      'How many rounds were played today?',
      'What was our utilization rate this week?',
      'How fast are rounds playing?',
      'Utilization by channel',
    ],
    systemPromptFragment:
      'You are analyzing golf operations. Key metrics: rounds_played (volume), utilization_rate (efficiency), avg_pace_of_play (operations). Always include date dimension for utilization_rate — it is required.',
  },
  {
    slug: 'golf_revenue',
    displayName: 'Golf Revenue',
    description: 'Green fee revenue, total golf revenue, cart, and yield metrics',
    domain: 'golf',
    isSystem: true,
    allowedMetrics: ['green_fee_revenue', 'total_golf_revenue', 'revenue_per_round', 'rounds_played', 'cart_revenue'],
    allowedDimensions: ['date', 'golf_course', 'booking_channel', 'daypart', 'player_type', 'day_of_week'],
    defaultMetrics: ['total_golf_revenue', 'rounds_played'],
    defaultDimensions: ['date'],
    exampleQuestions: [
      'What was our golf revenue today?',
      'Revenue per round by channel',
      'How much did we earn from green fees?',
      'Golf revenue trend this month',
      'Cart revenue by player type',
    ],
    systemPromptFragment:
      'You are analyzing golf revenue. Use green_fee_revenue for pure green fee analysis, total_golf_revenue for all-in revenue (includes cart), revenue_per_round for yield analysis, and cart_revenue for cart rental income.',
  },
];

// ── PMS Dimensions ────────────────────────────────────────────────

export const PMS_DIMENSIONS: Omit<DimensionDef, 'isActive'>[] = [
  {
    slug: 'property',
    displayName: 'Property',
    description: 'Hotel property or resort location',
    domain: 'pms',
    category: 'geography',
    sqlExpression: 'property_id',
    sqlTable: 'rm_pms_daily_occupancy',
    sqlDataType: 'text',
    isTimeDimension: false,
    lookupTable: 'pms_properties',
    lookupKeyColumn: 'id',
    lookupLabelColumn: 'name',
    aliases: ['property', 'hotel', 'resort', 'branch'],
    examplePhrases: ['by property', 'which hotel', 'main resort'],
  },
  {
    slug: 'room_type',
    displayName: 'Room Type',
    description: 'Room type or category (standard, deluxe, suite, etc.)',
    domain: 'pms',
    category: 'product',
    sqlExpression: 'room_type_id',
    sqlTable: 'rm_pms_revenue_by_room_type',
    sqlDataType: 'text',
    isTimeDimension: false,
    lookupTable: 'pms_room_types',
    lookupKeyColumn: 'id',
    lookupLabelColumn: 'name',
    aliases: ['room category', 'room class', 'room type'],
    exampleValues: ['standard', 'deluxe', 'suite', 'penthouse'],
    examplePhrases: ['by room type', 'suites vs standard', 'which room type'],
  },
  {
    slug: 'housekeeper',
    displayName: 'Housekeeper',
    description: 'Individual housekeeper for productivity tracking',
    domain: 'pms',
    category: 'operation',
    sqlExpression: 'housekeeper_id',
    sqlTable: 'rm_pms_housekeeping_productivity',
    sqlDataType: 'text',
    isTimeDimension: false,
    lookupTable: 'pms_housekeepers',
    lookupKeyColumn: 'id',
    lookupLabelColumn: 'name',
    aliases: ['housekeeper', 'cleaner', 'staff member'],
    examplePhrases: ['by housekeeper', 'which housekeeper', 'per cleaner'],
  },
];

// ── PMS Metrics ───────────────────────────────────────────────────

export const PMS_METRICS: Omit<MetricDef, 'isActive' | 'isExperimental'>[] = [
  // Occupancy metrics (from rm_pms_daily_occupancy)
  {
    slug: 'occupancy_pct',
    displayName: 'Occupancy %',
    description: 'Percentage of available rooms occupied. Pre-aggregated daily per property.',
    domain: 'pms',
    category: 'efficiency',
    sqlExpression: 'SUM(rooms_occupied)::NUMERIC / NULLIF(SUM(rooms_available), 0) * 100',
    sqlTable: 'rm_pms_daily_occupancy',
    sqlAggregation: 'custom',
    dataType: 'percent',
    formatPattern: '0.0%',
    higherIsBetter: true,
    aliases: ['occupancy', 'occupancy rate', 'fill rate', 'occ'],
    examplePhrases: ['what is occupancy', 'occupancy rate', 'how full were we', 'occupancy today'],
    relatedMetrics: ['rooms_occupied', 'rooms_available', 'adr', 'revpar'],
    requiresDimensions: ['date'],
  },
  {
    slug: 'rooms_occupied',
    displayName: 'Rooms Occupied',
    description: 'Number of rooms occupied per day.',
    domain: 'pms',
    category: 'volume',
    sqlExpression: 'SUM(rooms_occupied)',
    sqlTable: 'rm_pms_daily_occupancy',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'rooms',
    higherIsBetter: true,
    aliases: ['rooms sold', 'occupied rooms', 'room nights sold'],
    examplePhrases: ['how many rooms sold', 'rooms occupied', 'room nights'],
    relatedMetrics: ['occupancy_pct', 'room_revenue', 'adr'],
  },
  {
    slug: 'rooms_available',
    displayName: 'Rooms Available',
    description: 'Total rooms available for sale (excluding out-of-order).',
    domain: 'pms',
    category: 'volume',
    sqlExpression: 'SUM(rooms_available)',
    sqlTable: 'rm_pms_daily_occupancy',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'rooms',
    higherIsBetter: null,
    aliases: ['available rooms', 'capacity', 'sellable rooms'],
    examplePhrases: ['how many rooms available', 'total capacity', 'rooms for sale'],
    relatedMetrics: ['rooms_occupied', 'occupancy_pct', 'rooms_ooo'],
  },
  {
    slug: 'rooms_ooo',
    displayName: 'Rooms Out of Order',
    description: 'Rooms out of order or out of service.',
    domain: 'pms',
    category: 'operations',
    sqlExpression: 'SUM(rooms_ooo)',
    sqlTable: 'rm_pms_daily_occupancy',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'rooms',
    higherIsBetter: false,
    aliases: ['out of order', 'ooo rooms', 'out of service'],
    examplePhrases: ['how many rooms out of order', 'ooo rooms', 'rooms out of service'],
    relatedMetrics: ['rooms_available', 'occupancy_pct'],
  },
  {
    slug: 'arrivals',
    displayName: 'Arrivals',
    description: 'Number of guest arrivals (check-ins) per day.',
    domain: 'pms',
    category: 'volume',
    sqlExpression: 'SUM(arrivals)',
    sqlTable: 'rm_pms_daily_occupancy',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'arrivals',
    higherIsBetter: true,
    aliases: ['check-ins', 'arriving guests', 'arrivals today'],
    examplePhrases: ['how many arrivals', 'check-ins today', 'who is arriving'],
    relatedMetrics: ['departures', 'rooms_occupied'],
  },
  {
    slug: 'departures',
    displayName: 'Departures',
    description: 'Number of guest departures (check-outs) per day.',
    domain: 'pms',
    category: 'volume',
    sqlExpression: 'SUM(departures)',
    sqlTable: 'rm_pms_daily_occupancy',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'departures',
    higherIsBetter: null,
    aliases: ['check-outs', 'departing guests', 'departures today'],
    examplePhrases: ['how many departures', 'check-outs today', 'who is leaving'],
    relatedMetrics: ['arrivals', 'rooms_occupied'],
  },
  {
    slug: 'adr',
    displayName: 'ADR',
    description: 'Average Daily Rate — average nightly room rate in cents. Pre-aggregated per property per day.',
    domain: 'pms',
    category: 'efficiency',
    sqlExpression: 'SUM(adr_cents * rooms_occupied)::NUMERIC / NULLIF(SUM(rooms_occupied), 0) / 100',
    sqlTable: 'rm_pms_daily_occupancy',
    sqlAggregation: 'custom',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['average daily rate', 'avg rate', 'nightly rate', 'average room rate'],
    examplePhrases: ['what is our adr', 'average daily rate', 'average room rate'],
    relatedMetrics: ['room_revenue', 'revpar', 'occupancy_pct'],
  },
  {
    slug: 'revpar',
    displayName: 'RevPAR',
    description: 'Revenue Per Available Room. Combines occupancy and rate performance.',
    domain: 'pms',
    category: 'efficiency',
    sqlExpression: 'SUM(revpar_cents * rooms_available)::NUMERIC / NULLIF(SUM(rooms_available), 0) / 100',
    sqlTable: 'rm_pms_daily_occupancy',
    sqlAggregation: 'custom',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['revenue per available room', 'revpar'],
    examplePhrases: ['what is revpar', 'revenue per available room', 'revpar today'],
    relatedMetrics: ['adr', 'occupancy_pct', 'room_revenue'],
    requiresDimensions: ['date'],
  },
  // Revenue metrics (from rm_pms_revenue_by_room_type)
  {
    slug: 'room_revenue',
    displayName: 'Room Revenue',
    description: 'Total room revenue in cents, pre-aggregated daily per property and room type.',
    domain: 'pms',
    category: 'revenue',
    sqlExpression: 'SUM(room_revenue_cents)::NUMERIC / 100',
    sqlTable: 'rm_pms_revenue_by_room_type',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['room sales', 'lodging revenue', 'accommodation revenue'],
    examplePhrases: ['room revenue', 'how much room revenue', 'room sales today'],
    relatedMetrics: ['rooms_occupied', 'adr', 'revpar', 'tax_revenue_pms'],
  },
  {
    slug: 'tax_revenue_pms',
    displayName: 'Room Tax Revenue',
    description: 'Tax revenue from room charges in cents.',
    domain: 'pms',
    category: 'revenue',
    sqlExpression: 'SUM(tax_revenue_cents)::NUMERIC / 100',
    sqlTable: 'rm_pms_revenue_by_room_type',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: null,
    aliases: ['room tax', 'lodging tax', 'hotel tax'],
    examplePhrases: ['room tax collected', 'how much tax on rooms', 'lodging tax'],
    relatedMetrics: ['room_revenue'],
  },
  {
    slug: 'rooms_sold_by_type',
    displayName: 'Rooms Sold by Type',
    description: 'Number of room nights sold, breakable by room type.',
    domain: 'pms',
    category: 'volume',
    sqlExpression: 'SUM(rooms_sold)',
    sqlTable: 'rm_pms_revenue_by_room_type',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'rooms',
    higherIsBetter: true,
    aliases: ['rooms sold', 'room nights by type'],
    examplePhrases: ['rooms sold by type', 'which room type sells most'],
    relatedMetrics: ['room_revenue', 'adr'],
  },
  {
    slug: 'adr_by_room_type',
    displayName: 'ADR by Room Type',
    description: 'Average daily rate per room type in cents.',
    domain: 'pms',
    category: 'efficiency',
    sqlExpression: 'SUM(room_revenue_cents)::NUMERIC / NULLIF(SUM(rooms_sold), 0) / 100',
    sqlTable: 'rm_pms_revenue_by_room_type',
    sqlAggregation: 'custom',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['rate by room type', 'room type adr'],
    examplePhrases: ['adr by room type', 'which room type has highest rate'],
    relatedMetrics: ['room_revenue', 'rooms_sold_by_type'],
  },
  // Reservation metrics (from pms_reservations — direct operational table)
  {
    slug: 'reservation_count',
    displayName: 'Reservation Count',
    description: 'Count of reservations. Filter by check_in_date for arrivals, check_out_date for departures. Queries pms_reservations directly (not a read model).',
    domain: 'pms',
    category: 'volume',
    sqlExpression: 'COUNT(*)',
    sqlTable: 'pms_reservations',
    sqlAggregation: 'count',
    sqlFilter: "status IN ('CONFIRMED', 'HOLD', 'CHECKED_IN')",
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'reservations',
    higherIsBetter: true,
    aliases: ['reservations', 'bookings', 'booking count', 'number of reservations'],
    examplePhrases: ['how many reservations', 'reservations for next week', 'bookings this month', 'upcoming reservations'],
    relatedMetrics: ['arrivals', 'rooms_occupied', 'room_revenue'],
  },
  {
    slug: 'cancellation_count',
    displayName: 'Cancellation Count',
    description: 'Count of cancelled reservations.',
    domain: 'pms',
    category: 'volume',
    sqlExpression: 'COUNT(*)',
    sqlTable: 'pms_reservations',
    sqlAggregation: 'count',
    sqlFilter: "status = 'CANCELLED'",
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'cancellations',
    higherIsBetter: false,
    aliases: ['cancellations', 'cancelled bookings', 'cancelled reservations'],
    examplePhrases: ['how many cancellations', 'cancellation rate', 'cancelled reservations'],
    relatedMetrics: ['reservation_count', 'no_show_count'],
  },
  {
    slug: 'no_show_count',
    displayName: 'No-Show Count',
    description: 'Count of no-show reservations.',
    domain: 'pms',
    category: 'volume',
    sqlExpression: 'COUNT(*)',
    sqlTable: 'pms_reservations',
    sqlAggregation: 'count',
    sqlFilter: "status = 'NO_SHOW'",
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'no-shows',
    higherIsBetter: false,
    aliases: ['no shows', 'no-show count'],
    examplePhrases: ['how many no-shows', 'no-show rate'],
    relatedMetrics: ['reservation_count', 'cancellation_count'],
  },
  {
    slug: 'avg_nightly_rate',
    displayName: 'Avg Nightly Rate (Booked)',
    description: 'Average nightly rate across reservations in cents, converted to dollars.',
    domain: 'pms',
    category: 'efficiency',
    sqlExpression: 'AVG(nightly_rate_cents)::NUMERIC / 100',
    sqlTable: 'pms_reservations',
    sqlAggregation: 'avg',
    sqlFilter: "status IN ('CONFIRMED', 'HOLD', 'CHECKED_IN', 'CHECKED_OUT')",
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['average booked rate', 'booked adr', 'booking rate'],
    examplePhrases: ['average rate on reservations', 'booked rate this month'],
    relatedMetrics: ['adr', 'room_revenue', 'reservation_count'],
  },
  {
    slug: 'avg_length_of_stay',
    displayName: 'Avg Length of Stay',
    description: 'Average nights per reservation.',
    domain: 'pms',
    category: 'efficiency',
    sqlExpression: 'AVG(nights)::NUMERIC',
    sqlTable: 'pms_reservations',
    sqlAggregation: 'avg',
    sqlFilter: "status IN ('CONFIRMED', 'HOLD', 'CHECKED_IN', 'CHECKED_OUT')",
    dataType: 'number',
    formatPattern: '0.1',
    unit: 'nights',
    higherIsBetter: null,
    aliases: ['alos', 'average stay length', 'avg nights'],
    examplePhrases: ['average length of stay', 'how long do guests stay', 'alos'],
    relatedMetrics: ['reservation_count', 'rooms_occupied'],
  },
  // Housekeeping metrics (from rm_pms_housekeeping_productivity)
  {
    slug: 'rooms_cleaned',
    displayName: 'Rooms Cleaned',
    description: 'Number of rooms cleaned per housekeeper per day.',
    domain: 'pms',
    category: 'operations',
    sqlExpression: 'SUM(rooms_cleaned)',
    sqlTable: 'rm_pms_housekeeping_productivity',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'rooms',
    higherIsBetter: true,
    aliases: ['cleaned rooms', 'rooms cleaned today'],
    examplePhrases: ['how many rooms cleaned', 'rooms cleaned today', 'housekeeping volume'],
    relatedMetrics: ['avg_cleaning_time', 'total_cleaning_minutes'],
  },
  {
    slug: 'avg_cleaning_time',
    displayName: 'Avg Cleaning Time',
    description: 'Average cleaning time per room in minutes.',
    domain: 'pms',
    category: 'efficiency',
    sqlExpression: 'SUM(total_minutes)::NUMERIC / NULLIF(SUM(rooms_cleaned), 0)',
    sqlTable: 'rm_pms_housekeeping_productivity',
    sqlAggregation: 'custom',
    dataType: 'number',
    formatPattern: '0.0',
    unit: 'minutes',
    higherIsBetter: false,
    aliases: ['cleaning time', 'average clean time', 'minutes per room'],
    examplePhrases: ['average cleaning time', 'how long to clean a room', 'cleaning minutes'],
    relatedMetrics: ['rooms_cleaned', 'total_cleaning_minutes'],
  },
  {
    slug: 'total_cleaning_minutes',
    displayName: 'Total Cleaning Minutes',
    description: 'Total minutes spent on housekeeping.',
    domain: 'pms',
    category: 'operations',
    sqlExpression: 'SUM(total_minutes)',
    sqlTable: 'rm_pms_housekeeping_productivity',
    sqlAggregation: 'sum',
    dataType: 'number',
    formatPattern: '0,0',
    unit: 'minutes',
    higherIsBetter: null,
    aliases: ['total cleaning time', 'housekeeping hours'],
    examplePhrases: ['total cleaning time', 'how many hours of housekeeping'],
    relatedMetrics: ['rooms_cleaned', 'avg_cleaning_time'],
  },
];

// ── PMS Metric–Dimension relations ────────────────────────────────

export const PMS_METRIC_DIMENSIONS: MetricDimensionRelation[] = [
  // occupancy_pct (date REQUIRED)
  { metricSlug: 'occupancy_pct', dimensionSlug: 'date', isRequired: true, isDefault: true, sortOrder: 0 },
  { metricSlug: 'occupancy_pct', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  // rooms_occupied
  { metricSlug: 'rooms_occupied', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'rooms_occupied', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  // rooms_available
  { metricSlug: 'rooms_available', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'rooms_available', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  // rooms_ooo
  { metricSlug: 'rooms_ooo', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'rooms_ooo', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  // arrivals
  { metricSlug: 'arrivals', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'arrivals', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  // departures
  { metricSlug: 'departures', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'departures', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  // adr
  { metricSlug: 'adr', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'adr', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  // revpar (date REQUIRED)
  { metricSlug: 'revpar', dimensionSlug: 'date', isRequired: true, isDefault: true, sortOrder: 0 },
  { metricSlug: 'revpar', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  // room_revenue
  { metricSlug: 'room_revenue', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'room_revenue', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'room_revenue', dimensionSlug: 'room_type', isRequired: false, isDefault: false, sortOrder: 2 },
  // tax_revenue_pms
  { metricSlug: 'tax_revenue_pms', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'tax_revenue_pms', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'tax_revenue_pms', dimensionSlug: 'room_type', isRequired: false, isDefault: false, sortOrder: 2 },
  // rooms_sold_by_type
  { metricSlug: 'rooms_sold_by_type', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'rooms_sold_by_type', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'rooms_sold_by_type', dimensionSlug: 'room_type', isRequired: false, isDefault: true, sortOrder: 2 },
  // adr_by_room_type
  { metricSlug: 'adr_by_room_type', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'adr_by_room_type', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'adr_by_room_type', dimensionSlug: 'room_type', isRequired: false, isDefault: true, sortOrder: 2 },
  // rooms_cleaned
  { metricSlug: 'rooms_cleaned', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'rooms_cleaned', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'rooms_cleaned', dimensionSlug: 'housekeeper', isRequired: false, isDefault: true, sortOrder: 2 },
  // avg_cleaning_time
  { metricSlug: 'avg_cleaning_time', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'avg_cleaning_time', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'avg_cleaning_time', dimensionSlug: 'housekeeper', isRequired: false, isDefault: true, sortOrder: 2 },
  // total_cleaning_minutes
  { metricSlug: 'total_cleaning_minutes', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'total_cleaning_minutes', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'total_cleaning_minutes', dimensionSlug: 'housekeeper', isRequired: false, isDefault: true, sortOrder: 2 },
  // reservation_count
  { metricSlug: 'reservation_count', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'reservation_count', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  // cancellation_count
  { metricSlug: 'cancellation_count', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'cancellation_count', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  // no_show_count
  { metricSlug: 'no_show_count', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'no_show_count', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  // avg_nightly_rate
  { metricSlug: 'avg_nightly_rate', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'avg_nightly_rate', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
  // avg_length_of_stay
  { metricSlug: 'avg_length_of_stay', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'avg_length_of_stay', dimensionSlug: 'property', isRequired: false, isDefault: false, sortOrder: 1 },
];

// ── PMS System Lenses ─────────────────────────────────────────────

export const PMS_SYSTEM_LENSES: Omit<LensDef, 'isActive'>[] = [
  {
    slug: 'pms_occupancy',
    displayName: 'Occupancy & Rate',
    description: 'Hotel occupancy, ADR, and RevPAR analysis',
    domain: 'pms',
    isSystem: true,
    allowedMetrics: ['occupancy_pct', 'adr', 'revpar', 'rooms_occupied', 'rooms_available', 'rooms_ooo', 'arrivals', 'departures'],
    allowedDimensions: ['date', 'property', 'week', 'month'],
    defaultMetrics: ['occupancy_pct', 'adr'],
    defaultDimensions: ['date'],
    exampleQuestions: [
      'What is our occupancy today?',
      'How has occupancy trended this month?',
      'ADR and RevPAR this week',
      'How many arrivals and departures today?',
    ],
    systemPromptFragment:
      'You are analyzing hotel occupancy and rate performance. Key metrics: occupancy_pct (rooms occupied %), adr (average nightly rate), revpar (occupancy-adjusted revenue). USALI (Uniform System of Accounts for the Lodging Industry) definitions. Always include date dimension for occupancy_pct and revpar.',
  },
  {
    slug: 'pms_revenue',
    displayName: 'Room Revenue',
    description: 'Room revenue analysis by room type and property',
    domain: 'pms',
    isSystem: true,
    allowedMetrics: ['room_revenue', 'tax_revenue_pms', 'rooms_sold_by_type', 'adr_by_room_type'],
    allowedDimensions: ['date', 'property', 'room_type', 'week', 'month'],
    defaultMetrics: ['room_revenue', 'rooms_sold_by_type'],
    defaultDimensions: ['date'],
    exampleQuestions: [
      'How much room revenue today?',
      'Revenue by room type this month',
      'Which room type has highest ADR?',
      'Room revenue trend this quarter',
    ],
    systemPromptFragment:
      'You are analyzing room revenue. Use room_revenue for total dollars, rooms_sold_by_type for volume, adr_by_room_type for yield per type. Break down by room_type to compare Standard vs Deluxe vs Suite performance.',
  },
  {
    slug: 'pms_housekeeping',
    displayName: 'Housekeeping',
    description: 'Housekeeping productivity and efficiency metrics',
    domain: 'pms',
    isSystem: true,
    allowedMetrics: ['rooms_cleaned', 'avg_cleaning_time', 'total_cleaning_minutes'],
    allowedDimensions: ['date', 'property', 'housekeeper', 'week', 'month'],
    defaultMetrics: ['rooms_cleaned', 'avg_cleaning_time'],
    defaultDimensions: ['date'],
    exampleQuestions: [
      'How many rooms cleaned today?',
      'Average cleaning time per housekeeper',
      'Which housekeeper is most efficient?',
      'Housekeeping productivity this week',
    ],
    systemPromptFragment:
      'You are analyzing housekeeping operations. Key metrics: rooms_cleaned (volume), avg_cleaning_time (efficiency), total_cleaning_minutes (labor). Break down by housekeeper for individual performance tracking.',
  },
  {
    slug: 'pms_reservations',
    displayName: 'Reservations',
    description: 'Reservation volume, cancellations, no-shows, and booking analytics. For specific guest details or reservation lists, use SQL mode.',
    domain: 'pms',
    isSystem: true,
    allowedMetrics: ['reservation_count', 'cancellation_count', 'no_show_count', 'avg_nightly_rate', 'avg_length_of_stay', 'arrivals', 'departures'],
    allowedDimensions: ['date', 'property', 'week', 'month'],
    defaultMetrics: ['reservation_count', 'arrivals'],
    defaultDimensions: ['date'],
    exampleQuestions: [
      'How many reservations for next week?',
      'Reservation count this month',
      'How many cancellations last month?',
      'Average length of stay',
      'What is our no-show rate?',
      'How many arrivals for next Tuesday?',
    ],
    systemPromptFragment:
      'You are analyzing reservation data. reservation_count queries pms_reservations directly (active bookings: CONFIRMED/HOLD/CHECKED_IN). For date-specific queries, use check_in_date filtering. For detailed guest lists or room assignments, route to SQL mode. cancellation_count and no_show_count track problematic bookings. avg_nightly_rate shows the average booked rate in dollars. avg_length_of_stay shows average nights per booking.',
  },
];

// ── Spa Dimensions ───────────────────────────────────────────────

export const SPA_DIMENSIONS: Omit<DimensionDef, 'isActive'>[] = [
  {
    slug: 'spa_location',
    displayName: 'Spa Location',
    description: 'Spa location / outlet',
    domain: 'spa',
    category: 'geography',
    sqlExpression: 'location_id',
    sqlTable: 'rm_spa_daily_operations',
    sqlDataType: 'text',
    isTimeDimension: false,
    lookupTable: 'locations',
    lookupKeyColumn: 'id',
    lookupLabelColumn: 'name',
    aliases: ['spa', 'spa location', 'spa outlet'],
    examplePhrases: ['by spa location', 'which spa', 'per location'],
  },
];

// ── Spa Metrics ──────────────────────────────────────────────────

export const SPA_METRICS: Omit<MetricDef, 'isActive' | 'isExperimental'>[] = [
  // ── rm_spa_daily_operations count metrics ──────────────────────
  {
    slug: 'spa_appointment_count',
    displayName: 'Spa Appointment Count',
    description: 'Total number of spa appointments. Pre-aggregated daily per location from rm_spa_daily_operations.',
    domain: 'spa',
    category: 'volume',
    sqlExpression: 'SUM(appointment_count)',
    sqlTable: 'rm_spa_daily_operations',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'appointments',
    higherIsBetter: true,
    aliases: ['spa appointments', 'spa bookings', 'appointment count'],
    examplePhrases: ['how many spa appointments', 'spa bookings today', 'total appointments'],
    relatedMetrics: ['spa_completed_count', 'spa_canceled_count', 'spa_total_revenue'],
  },
  {
    slug: 'spa_completed_count',
    displayName: 'Spa Completed Count',
    description: 'Number of completed spa appointments. Pre-aggregated daily per location.',
    domain: 'spa',
    category: 'volume',
    sqlExpression: 'SUM(completed_count)',
    sqlTable: 'rm_spa_daily_operations',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'appointments',
    higherIsBetter: true,
    aliases: ['completed appointments', 'finished appointments', 'spa completed'],
    examplePhrases: ['how many completed spa appointments', 'spa completions today'],
    relatedMetrics: ['spa_appointment_count', 'spa_canceled_count'],
  },
  {
    slug: 'spa_canceled_count',
    displayName: 'Spa Canceled Count',
    description: 'Number of canceled spa appointments. Pre-aggregated daily per location.',
    domain: 'spa',
    category: 'operations',
    sqlExpression: 'SUM(canceled_count)',
    sqlTable: 'rm_spa_daily_operations',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'appointments',
    higherIsBetter: false,
    aliases: ['spa cancellations', 'canceled appointments', 'spa canceled'],
    examplePhrases: ['how many spa cancellations', 'canceled appointments today'],
    relatedMetrics: ['spa_appointment_count', 'spa_no_show_count'],
  },
  {
    slug: 'spa_no_show_count',
    displayName: 'Spa No-Show Count',
    description: 'Number of spa no-shows. Pre-aggregated daily per location.',
    domain: 'spa',
    category: 'operations',
    sqlExpression: 'SUM(no_show_count)',
    sqlTable: 'rm_spa_daily_operations',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'appointments',
    higherIsBetter: false,
    aliases: ['spa no-shows', 'no shows', 'missed appointments'],
    examplePhrases: ['how many spa no-shows', 'no-shows today', 'missed spa appointments'],
    relatedMetrics: ['spa_appointment_count', 'spa_canceled_count'],
  },
  {
    slug: 'spa_walk_in_count',
    displayName: 'Spa Walk-In Count',
    description: 'Number of walk-in spa appointments. Pre-aggregated daily per location.',
    domain: 'spa',
    category: 'volume',
    sqlExpression: 'SUM(walk_in_count)',
    sqlTable: 'rm_spa_daily_operations',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'appointments',
    higherIsBetter: true,
    aliases: ['walk-ins', 'spa walk-ins', 'walk in appointments'],
    examplePhrases: ['how many walk-ins', 'spa walk-ins today', 'walk-in count'],
    relatedMetrics: ['spa_appointment_count', 'spa_online_booking_count'],
  },
  {
    slug: 'spa_online_booking_count',
    displayName: 'Spa Online Bookings',
    description: 'Number of online spa bookings. Pre-aggregated daily per location.',
    domain: 'spa',
    category: 'volume',
    sqlExpression: 'SUM(online_booking_count)',
    sqlTable: 'rm_spa_daily_operations',
    sqlAggregation: 'sum',
    dataType: 'integer',
    formatPattern: '0,0',
    unit: 'bookings',
    higherIsBetter: true,
    aliases: ['online bookings', 'spa online bookings', 'web bookings'],
    examplePhrases: ['how many online spa bookings', 'online bookings today', 'web bookings this week'],
    relatedMetrics: ['spa_appointment_count', 'spa_walk_in_count'],
  },
  // ── rm_spa_daily_operations revenue metrics ────────────────────
  {
    slug: 'spa_total_revenue',
    displayName: 'Spa Total Revenue',
    description: 'Total spa revenue in dollars. Pre-aggregated daily per location from rm_spa_daily_operations.',
    domain: 'spa',
    category: 'revenue',
    sqlExpression: 'SUM(total_revenue)',
    sqlTable: 'rm_spa_daily_operations',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['spa revenue', 'spa sales', 'spa income', 'total spa revenue'],
    examplePhrases: ['spa revenue today', 'how much did the spa make', 'total spa sales'],
    relatedMetrics: ['spa_service_revenue', 'spa_addon_revenue', 'spa_retail_revenue'],
  },
  {
    slug: 'spa_service_revenue',
    displayName: 'Spa Service Revenue',
    description: 'Revenue from spa services in dollars. Pre-aggregated daily per location.',
    domain: 'spa',
    category: 'revenue',
    sqlExpression: 'SUM(service_revenue)',
    sqlTable: 'rm_spa_daily_operations',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['service revenue', 'spa service sales', 'treatment revenue'],
    examplePhrases: ['spa service revenue', 'revenue from treatments', 'service sales today'],
    relatedMetrics: ['spa_total_revenue', 'spa_addon_revenue'],
  },
  {
    slug: 'spa_addon_revenue',
    displayName: 'Spa Add-On Revenue',
    description: 'Revenue from spa add-ons in dollars. Pre-aggregated daily per location.',
    domain: 'spa',
    category: 'revenue',
    sqlExpression: 'SUM(addon_revenue)',
    sqlTable: 'rm_spa_daily_operations',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['add-on revenue', 'spa addon sales', 'upsell revenue'],
    examplePhrases: ['spa add-on revenue', 'addon sales today', 'upsell revenue this week'],
    relatedMetrics: ['spa_total_revenue', 'spa_service_revenue'],
  },
  {
    slug: 'spa_retail_revenue',
    displayName: 'Spa Retail Revenue',
    description: 'Revenue from spa retail products in dollars. Pre-aggregated daily per location.',
    domain: 'spa',
    category: 'revenue',
    sqlExpression: 'SUM(retail_revenue)',
    sqlTable: 'rm_spa_daily_operations',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['retail revenue', 'spa retail sales', 'product sales'],
    examplePhrases: ['spa retail sales', 'product revenue today', 'how much retail did the spa sell'],
    relatedMetrics: ['spa_total_revenue', 'spa_service_revenue'],
  },
  {
    slug: 'spa_tip_total',
    displayName: 'Spa Tips',
    description: 'Total tips from spa services in dollars. Pre-aggregated daily per location.',
    domain: 'spa',
    category: 'revenue',
    sqlExpression: 'SUM(tip_total)',
    sqlTable: 'rm_spa_daily_operations',
    sqlAggregation: 'sum',
    dataType: 'currency',
    formatPattern: '$0,0.00',
    unit: 'USD',
    higherIsBetter: true,
    aliases: ['spa tips', 'tip total', 'gratuities'],
    examplePhrases: ['spa tips today', 'total tips this week', 'how much in tips'],
    relatedMetrics: ['spa_total_revenue', 'spa_completed_count'],
  },
  // ── rm_spa_daily_operations efficiency metrics ─────────────────
  {
    slug: 'spa_avg_appointment_duration',
    displayName: 'Spa Avg Duration',
    description: 'Average spa appointment duration in minutes. Pre-aggregated daily per location.',
    domain: 'spa',
    category: 'efficiency',
    sqlExpression: 'SUM(avg_appointment_duration * completed_count)::NUMERIC / NULLIF(SUM(completed_count), 0)',
    sqlTable: 'rm_spa_daily_operations',
    sqlAggregation: 'custom',
    dataType: 'integer',
    formatPattern: '0',
    unit: 'minutes',
    higherIsBetter: null,
    aliases: ['average duration', 'spa appointment length', 'avg appointment time'],
    examplePhrases: ['average spa appointment length', 'how long are spa appointments', 'avg duration'],
    relatedMetrics: ['spa_completed_count', 'spa_utilization_pct'],
  },
  {
    slug: 'spa_utilization_pct',
    displayName: 'Spa Utilization %',
    description: 'Spa provider utilization percentage. Pre-aggregated daily per location.',
    domain: 'spa',
    category: 'efficiency',
    sqlExpression: 'SUM(utilization_pct * completed_count)::NUMERIC / NULLIF(SUM(completed_count), 0)',
    sqlTable: 'rm_spa_daily_operations',
    sqlAggregation: 'custom',
    dataType: 'percentage',
    formatPattern: '0.0%',
    unit: '%',
    higherIsBetter: true,
    aliases: ['utilization', 'spa utilization', 'provider utilization', 'capacity usage'],
    examplePhrases: ['spa utilization rate', 'how busy is the spa', 'provider utilization today'],
    relatedMetrics: ['spa_completed_count', 'spa_appointment_count'],
  },
  {
    slug: 'spa_rebooking_rate',
    displayName: 'Spa Rebooking Rate',
    description: 'Rate of spa clients rebooking. Pre-aggregated daily per location.',
    domain: 'spa',
    category: 'efficiency',
    sqlExpression: 'SUM(rebooking_rate * completed_count)::NUMERIC / NULLIF(SUM(completed_count), 0)',
    sqlTable: 'rm_spa_daily_operations',
    sqlAggregation: 'custom',
    dataType: 'percentage',
    formatPattern: '0.0%',
    unit: '%',
    higherIsBetter: true,
    aliases: ['rebooking rate', 'return rate', 'repeat booking rate', 'rebook rate'],
    examplePhrases: ['spa rebooking rate', 'how many clients rebook', 'return rate this month'],
    relatedMetrics: ['spa_completed_count', 'spa_appointment_count'],
  },
];

// ── Spa Metric–Dimension relations ──────────────────────────────

export const SPA_METRIC_DIMENSIONS: MetricDimensionRelation[] = [
  // spa_appointment_count
  { metricSlug: 'spa_appointment_count', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'spa_appointment_count', dimensionSlug: 'spa_location', isRequired: false, isDefault: false, sortOrder: 1 },
  // spa_completed_count
  { metricSlug: 'spa_completed_count', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'spa_completed_count', dimensionSlug: 'spa_location', isRequired: false, isDefault: false, sortOrder: 1 },
  // spa_canceled_count
  { metricSlug: 'spa_canceled_count', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'spa_canceled_count', dimensionSlug: 'spa_location', isRequired: false, isDefault: false, sortOrder: 1 },
  // spa_no_show_count
  { metricSlug: 'spa_no_show_count', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'spa_no_show_count', dimensionSlug: 'spa_location', isRequired: false, isDefault: false, sortOrder: 1 },
  // spa_walk_in_count
  { metricSlug: 'spa_walk_in_count', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'spa_walk_in_count', dimensionSlug: 'spa_location', isRequired: false, isDefault: false, sortOrder: 1 },
  // spa_online_booking_count
  { metricSlug: 'spa_online_booking_count', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'spa_online_booking_count', dimensionSlug: 'spa_location', isRequired: false, isDefault: false, sortOrder: 1 },
  // spa_total_revenue
  { metricSlug: 'spa_total_revenue', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'spa_total_revenue', dimensionSlug: 'spa_location', isRequired: false, isDefault: false, sortOrder: 1 },
  // spa_service_revenue
  { metricSlug: 'spa_service_revenue', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'spa_service_revenue', dimensionSlug: 'spa_location', isRequired: false, isDefault: false, sortOrder: 1 },
  // spa_addon_revenue
  { metricSlug: 'spa_addon_revenue', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'spa_addon_revenue', dimensionSlug: 'spa_location', isRequired: false, isDefault: false, sortOrder: 1 },
  // spa_retail_revenue
  { metricSlug: 'spa_retail_revenue', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'spa_retail_revenue', dimensionSlug: 'spa_location', isRequired: false, isDefault: false, sortOrder: 1 },
  // spa_tip_total
  { metricSlug: 'spa_tip_total', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'spa_tip_total', dimensionSlug: 'spa_location', isRequired: false, isDefault: false, sortOrder: 1 },
  // spa_avg_appointment_duration
  { metricSlug: 'spa_avg_appointment_duration', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 0 },
  { metricSlug: 'spa_avg_appointment_duration', dimensionSlug: 'spa_location', isRequired: false, isDefault: false, sortOrder: 1 },
  // spa_utilization_pct (date REQUIRED for meaningful percentage)
  { metricSlug: 'spa_utilization_pct', dimensionSlug: 'date', isRequired: true, isDefault: true, sortOrder: 0 },
  { metricSlug: 'spa_utilization_pct', dimensionSlug: 'spa_location', isRequired: false, isDefault: false, sortOrder: 1 },
  // spa_rebooking_rate (date REQUIRED for meaningful percentage)
  { metricSlug: 'spa_rebooking_rate', dimensionSlug: 'date', isRequired: true, isDefault: true, sortOrder: 0 },
  { metricSlug: 'spa_rebooking_rate', dimensionSlug: 'spa_location', isRequired: false, isDefault: false, sortOrder: 1 },
];

// ── Spa System Lenses ────────────────────────────────────────────

export const SPA_SYSTEM_LENSES: Omit<LensDef, 'isActive'>[] = [
  {
    slug: 'spa_operations',
    displayName: 'Spa Operations',
    description: 'Spa appointment volume, cancellations, no-shows, walk-ins, and online bookings',
    domain: 'spa',
    isSystem: true,
    allowedMetrics: [
      'spa_appointment_count', 'spa_completed_count', 'spa_canceled_count',
      'spa_no_show_count', 'spa_walk_in_count', 'spa_online_booking_count',
      'spa_utilization_pct', 'spa_avg_appointment_duration', 'spa_rebooking_rate',
    ],
    allowedDimensions: ['date', 'spa_location', 'week', 'month'],
    defaultMetrics: ['spa_appointment_count', 'spa_completed_count'],
    defaultDimensions: ['date'],
    exampleQuestions: [
      'How many spa appointments today?',
      'Spa cancellations this week?',
      'What is our spa utilization rate?',
      'How many walk-ins today?',
      'Online bookings this month?',
    ],
    systemPromptFragment:
      'You are analyzing spa operations. Key metrics: spa_appointment_count (volume), spa_completed_count (throughput), spa_utilization_pct (efficiency), spa_rebooking_rate (retention). Always include date dimension for utilization and rebooking metrics.',
  },
  {
    slug: 'spa_revenue',
    displayName: 'Spa Revenue',
    description: 'Spa revenue breakdown by services, add-ons, retail, and tips',
    domain: 'spa',
    isSystem: true,
    allowedMetrics: [
      'spa_total_revenue', 'spa_service_revenue', 'spa_addon_revenue',
      'spa_retail_revenue', 'spa_tip_total', 'spa_completed_count',
    ],
    allowedDimensions: ['date', 'spa_location', 'week', 'month'],
    defaultMetrics: ['spa_total_revenue', 'spa_service_revenue'],
    defaultDimensions: ['date'],
    exampleQuestions: [
      'Spa revenue today?',
      'How much in spa tips this week?',
      'Service vs retail revenue?',
      'Add-on revenue this month?',
      'Spa revenue trend',
    ],
    systemPromptFragment:
      'You are analyzing spa revenue. spa_total_revenue includes services + add-ons + retail. Break down with spa_service_revenue, spa_addon_revenue, and spa_retail_revenue. spa_tip_total tracks gratuities. All amounts are in dollars (NUMERIC).',
  },
];

// ── Accounting Dimensions ─────────────────────────────────────────

export const ACCT_DIMENSIONS: Omit<DimensionDef, 'isActive'>[] = [
  {
    slug: 'gl_account',
    displayName: 'GL Account',
    description: 'General ledger account (number + name)',
    domain: 'accounting',
    category: 'accounting',
    sqlExpression: 'ga.account_number',
    sqlTable: 'gl_accounts',
    sqlDataType: 'text',
    isTimeDimension: false,
    lookupTable: 'gl_accounts',
    lookupKeyColumn: 'id',
    lookupLabelColumn: 'name',
    aliases: ['account', 'ledger account', 'chart of accounts', 'coa'],
    examplePhrases: ['by account', 'per GL account', 'which accounts'],
  },
  {
    slug: 'gl_classification',
    displayName: 'GL Classification',
    description: 'GL account classification (asset, liability, equity, revenue, expense)',
    domain: 'accounting',
    category: 'accounting',
    sqlExpression: 'gc.name',
    sqlTable: 'gl_classifications',
    sqlDataType: 'text',
    isTimeDimension: false,
    lookupTable: 'gl_classifications',
    lookupKeyColumn: 'id',
    lookupLabelColumn: 'name',
    aliases: ['classification', 'account type', 'account class'],
    examplePhrases: ['by classification', 'revenue accounts', 'expense accounts', 'asset accounts'],
  },
  {
    slug: 'vendor',
    displayName: 'Vendor',
    description: 'AP vendor / supplier name',
    domain: 'accounting',
    category: 'accounting',
    sqlExpression: 'v.name',
    sqlTable: 'vendors',
    sqlDataType: 'text',
    isTimeDimension: false,
    lookupTable: 'vendors',
    lookupKeyColumn: 'id',
    lookupLabelColumn: 'name',
    aliases: ['supplier', 'payee'],
    examplePhrases: ['by vendor', 'which vendors', 'per supplier'],
  },
  {
    slug: 'ap_status',
    displayName: 'AP Bill Status',
    description: 'Accounts payable bill status (draft, posted, partial, paid, voided)',
    domain: 'accounting',
    category: 'accounting',
    sqlExpression: 'ab.status',
    sqlTable: 'ap_bills',
    sqlDataType: 'text',
    isTimeDimension: false,
    aliases: ['bill status', 'payable status'],
    exampleValues: ['draft', 'posted', 'partial', 'paid', 'voided'],
    examplePhrases: ['open bills', 'paid bills', 'outstanding payables'],
  },
  {
    slug: 'ar_status',
    displayName: 'AR Invoice Status',
    description: 'Accounts receivable invoice status (draft, posted, partial, paid, voided)',
    domain: 'accounting',
    category: 'accounting',
    sqlExpression: 'ai.status',
    sqlTable: 'ar_invoices',
    sqlDataType: 'text',
    isTimeDimension: false,
    aliases: ['invoice status', 'receivable status'],
    exampleValues: ['draft', 'posted', 'partial', 'paid', 'voided'],
    examplePhrases: ['open invoices', 'paid invoices', 'outstanding receivables'],
  },
];

// ── Accounting Metrics ────────────────────────────────────────────

export const ACCT_METRICS: Omit<MetricDef, 'isActive' | 'isExperimental'>[] = [
  {
    slug: 'total_revenue',
    displayName: 'Total Revenue',
    description: 'Sum of credit-normal revenue GL lines (posted entries only)',
    domain: 'accounting',
    category: 'financial',
    sqlExpression: 'SUM(CASE WHEN ga.normal_balance = \'credit\' THEN jl.credit_amount - jl.debit_amount ELSE 0 END)',
    sqlTable: 'gl_journal_lines jl JOIN gl_journal_entries je ON je.id = jl.journal_entry_id JOIN gl_accounts ga ON ga.id = jl.account_id',
    sqlAggregation: 'sum',
    sqlFilter: 'je.status = \'posted\' AND ga.account_type = \'revenue\'',
    dataType: 'currency',
    formatPattern: '$#,##0.00',
    unit: 'dollars',
    higherIsBetter: true,
    aliases: ['revenue', 'income', 'sales revenue', 'top line'],
    examplePhrases: ['total revenue', 'how much revenue', 'income this month'],
    relatedMetrics: ['total_expenses', 'net_income', 'gross_profit'],
  },
  {
    slug: 'total_expenses',
    displayName: 'Total Expenses',
    description: 'Sum of debit-normal expense GL lines (posted entries only)',
    domain: 'accounting',
    category: 'financial',
    sqlExpression: 'SUM(CASE WHEN ga.normal_balance = \'debit\' THEN jl.debit_amount - jl.credit_amount ELSE 0 END)',
    sqlTable: 'gl_journal_lines jl JOIN gl_journal_entries je ON je.id = jl.journal_entry_id JOIN gl_accounts ga ON ga.id = jl.account_id',
    sqlAggregation: 'sum',
    sqlFilter: 'je.status = \'posted\' AND ga.account_type = \'expense\'',
    dataType: 'currency',
    formatPattern: '$#,##0.00',
    unit: 'dollars',
    higherIsBetter: false,
    aliases: ['expenses', 'costs', 'spending', 'expenditures'],
    examplePhrases: ['total expenses', 'how much did we spend', 'costs this month'],
    relatedMetrics: ['total_revenue', 'net_income'],
  },
  {
    slug: 'net_income',
    displayName: 'Net Income',
    description: 'Revenue minus expenses from posted GL entries',
    domain: 'accounting',
    category: 'financial',
    sqlExpression: 'SUM(CASE WHEN ga.account_type = \'revenue\' THEN jl.credit_amount - jl.debit_amount WHEN ga.account_type = \'expense\' THEN -(jl.debit_amount - jl.credit_amount) ELSE 0 END)',
    sqlTable: 'gl_journal_lines jl JOIN gl_journal_entries je ON je.id = jl.journal_entry_id JOIN gl_accounts ga ON ga.id = jl.account_id',
    sqlAggregation: 'sum',
    sqlFilter: 'je.status = \'posted\' AND ga.account_type IN (\'revenue\', \'expense\')',
    dataType: 'currency',
    formatPattern: '$#,##0.00',
    unit: 'dollars',
    higherIsBetter: true,
    aliases: ['profit', 'bottom line', 'net profit', 'earnings'],
    examplePhrases: ['net income', 'profit this month', 'are we profitable', 'bottom line'],
    relatedMetrics: ['total_revenue', 'total_expenses', 'gross_profit'],
  },
  {
    slug: 'gl_entry_count',
    displayName: 'Journal Entry Count',
    description: 'Number of posted journal entries',
    domain: 'accounting',
    category: 'financial',
    sqlExpression: 'COUNT(*)',
    sqlTable: 'gl_journal_entries',
    sqlAggregation: 'count',
    sqlFilter: 'status = \'posted\'',
    dataType: 'integer',
    higherIsBetter: undefined,
    aliases: ['journal entries', 'GL entries', 'entry count'],
    examplePhrases: ['how many journal entries', 'entry count this month'],
    relatedMetrics: ['unmapped_event_count'],
  },
  {
    slug: 'ap_outstanding',
    displayName: 'AP Outstanding',
    description: 'Total outstanding accounts payable (bills with balance due)',
    domain: 'accounting',
    category: 'financial',
    sqlExpression: 'SUM(balance_due)',
    sqlTable: 'ap_bills',
    sqlAggregation: 'sum',
    sqlFilter: 'status IN (\'posted\', \'partial\') AND balance_due > 0',
    dataType: 'currency',
    formatPattern: '$#,##0.00',
    unit: 'dollars',
    higherIsBetter: false,
    aliases: ['payables', 'accounts payable', 'money we owe', 'total payables', 'AP balance'],
    examplePhrases: ['how much do we owe', 'total payables', 'AP outstanding', 'outstanding bills'],
    relatedMetrics: ['ar_outstanding', 'ap_overdue', 'ap_bill_count'],
  },
  {
    slug: 'ar_outstanding',
    displayName: 'AR Outstanding',
    description: 'Total outstanding accounts receivable (invoices with balance due)',
    domain: 'accounting',
    category: 'financial',
    sqlExpression: 'SUM(balance_due)',
    sqlTable: 'ar_invoices',
    sqlAggregation: 'sum',
    sqlFilter: 'status IN (\'posted\', \'partial\') AND balance_due > 0',
    dataType: 'currency',
    formatPattern: '$#,##0.00',
    unit: 'dollars',
    higherIsBetter: true,
    aliases: ['receivables', 'accounts receivable', 'money owed to us', 'total receivables', 'AR balance'],
    examplePhrases: ['how much are we owed', 'total receivables', 'AR outstanding', 'outstanding invoices'],
    relatedMetrics: ['ap_outstanding', 'ar_overdue', 'ar_invoice_count'],
  },
  {
    slug: 'ap_overdue',
    displayName: 'AP Overdue',
    description: 'Total amount of overdue AP bills (past due date)',
    domain: 'accounting',
    category: 'financial',
    sqlExpression: 'SUM(balance_due)',
    sqlTable: 'ap_bills',
    sqlAggregation: 'sum',
    sqlFilter: 'status IN (\'posted\', \'partial\') AND balance_due > 0 AND due_date::date < CURRENT_DATE',
    dataType: 'currency',
    formatPattern: '$#,##0.00',
    unit: 'dollars',
    higherIsBetter: false,
    aliases: ['overdue payables', 'past due bills', 'late bills'],
    examplePhrases: ['overdue bills', 'past due payables', 'late payments'],
    relatedMetrics: ['ap_outstanding', 'ap_bill_count'],
  },
  {
    slug: 'ar_overdue',
    displayName: 'AR Overdue',
    description: 'Total amount of overdue AR invoices (past due date)',
    domain: 'accounting',
    category: 'financial',
    sqlExpression: 'SUM(balance_due)',
    sqlTable: 'ar_invoices',
    sqlAggregation: 'sum',
    sqlFilter: 'status IN (\'posted\', \'partial\') AND balance_due > 0 AND due_date < CURRENT_DATE',
    dataType: 'currency',
    formatPattern: '$#,##0.00',
    unit: 'dollars',
    higherIsBetter: false,
    aliases: ['overdue receivables', 'past due invoices', 'late invoices'],
    examplePhrases: ['overdue invoices', 'past due receivables', 'late receivables'],
    relatedMetrics: ['ar_outstanding', 'ar_invoice_count'],
  },
  {
    slug: 'cash_position',
    displayName: 'Cash Position',
    description: 'Balance of cash and bank GL accounts',
    domain: 'accounting',
    category: 'financial',
    sqlExpression: 'SUM(jl.debit_amount - jl.credit_amount)',
    sqlTable: 'gl_journal_lines jl JOIN gl_journal_entries je ON je.id = jl.journal_entry_id JOIN gl_accounts ga ON ga.id = jl.account_id',
    sqlAggregation: 'sum',
    sqlFilter: 'je.status = \'posted\' AND ga.account_type = \'asset\' AND ga.account_number LIKE \'1%\'',
    dataType: 'currency',
    formatPattern: '$#,##0.00',
    unit: 'dollars',
    higherIsBetter: true,
    aliases: ['cash balance', 'cash on hand', 'bank balance', 'cash'],
    examplePhrases: ['cash position', 'how much cash', 'cash balance', 'bank balance'],
    relatedMetrics: ['total_revenue', 'total_expenses', 'net_income'],
  },
  {
    slug: 'trial_balance_total',
    displayName: 'Trial Balance Total',
    description: 'Total debits vs credits for trial balance verification',
    domain: 'accounting',
    category: 'financial',
    sqlExpression: 'SUM(jl.debit_amount)',
    sqlTable: 'gl_journal_lines jl JOIN gl_journal_entries je ON je.id = jl.journal_entry_id',
    sqlAggregation: 'sum',
    sqlFilter: 'je.status = \'posted\'',
    dataType: 'currency',
    formatPattern: '$#,##0.00',
    unit: 'dollars',
    higherIsBetter: undefined,
    aliases: ['trial balance', 'TB total'],
    examplePhrases: ['trial balance', 'total debits', 'does the trial balance balance'],
    relatedMetrics: ['gl_entry_count'],
  },
  {
    slug: 'unmapped_event_count',
    displayName: 'Unmapped GL Events',
    description: 'Count of financial events that could not be mapped to GL accounts',
    domain: 'accounting',
    category: 'financial',
    sqlExpression: 'COUNT(*)',
    sqlTable: 'gl_unmapped_events',
    sqlAggregation: 'count',
    dataType: 'integer',
    higherIsBetter: false,
    aliases: ['unmapped events', 'unmapped GL', 'GL gaps', 'posting gaps'],
    examplePhrases: ['unmapped events', 'how many unmapped', 'GL posting gaps'],
    relatedMetrics: ['gl_entry_count'],
  },
  {
    slug: 'ap_bill_count',
    displayName: 'AP Bill Count',
    description: 'Number of accounts payable bills',
    domain: 'accounting',
    category: 'financial',
    sqlExpression: 'COUNT(*)',
    sqlTable: 'ap_bills',
    sqlAggregation: 'count',
    dataType: 'integer',
    higherIsBetter: undefined,
    aliases: ['bill count', 'number of bills', 'payable count'],
    examplePhrases: ['how many bills', 'bill count', 'number of payables'],
    relatedMetrics: ['ap_outstanding', 'ap_overdue'],
  },
  {
    slug: 'ar_invoice_count',
    displayName: 'AR Invoice Count',
    description: 'Number of accounts receivable invoices',
    domain: 'accounting',
    category: 'financial',
    sqlExpression: 'COUNT(*)',
    sqlTable: 'ar_invoices',
    sqlAggregation: 'count',
    dataType: 'integer',
    higherIsBetter: undefined,
    aliases: ['invoice count', 'number of invoices', 'receivable count'],
    examplePhrases: ['how many invoices', 'invoice count', 'number of receivables'],
    relatedMetrics: ['ar_outstanding', 'ar_overdue'],
  },
  {
    slug: 'gross_profit',
    displayName: 'Gross Profit',
    description: 'Revenue minus cost of goods sold (COGS)',
    domain: 'accounting',
    category: 'financial',
    sqlExpression: 'SUM(CASE WHEN ga.account_type = \'revenue\' THEN jl.credit_amount - jl.debit_amount WHEN ga.account_type = \'expense\' AND ga.account_number LIKE \'5%\' THEN -(jl.debit_amount - jl.credit_amount) ELSE 0 END)',
    sqlTable: 'gl_journal_lines jl JOIN gl_journal_entries je ON je.id = jl.journal_entry_id JOIN gl_accounts ga ON ga.id = jl.account_id',
    sqlAggregation: 'sum',
    sqlFilter: 'je.status = \'posted\' AND (ga.account_type = \'revenue\' OR (ga.account_type = \'expense\' AND ga.account_number LIKE \'5%\'))',
    dataType: 'currency',
    formatPattern: '$#,##0.00',
    unit: 'dollars',
    higherIsBetter: true,
    aliases: ['gross margin', 'margin'],
    examplePhrases: ['gross profit', 'gross margin', 'margin this month'],
    relatedMetrics: ['total_revenue', 'total_expenses', 'net_income'],
  },
  {
    slug: 'expense_by_category',
    displayName: 'Expenses by Category',
    description: 'Expenses grouped by GL classification or account category',
    domain: 'accounting',
    category: 'financial',
    sqlExpression: 'SUM(jl.debit_amount - jl.credit_amount)',
    sqlTable: 'gl_journal_lines jl JOIN gl_journal_entries je ON je.id = jl.journal_entry_id JOIN gl_accounts ga ON ga.id = jl.account_id',
    sqlAggregation: 'sum',
    sqlFilter: 'je.status = \'posted\' AND ga.account_type = \'expense\'',
    dataType: 'currency',
    formatPattern: '$#,##0.00',
    unit: 'dollars',
    higherIsBetter: false,
    aliases: ['expense breakdown', 'spending by category', 'cost breakdown'],
    examplePhrases: ['expenses by category', 'spending breakdown', 'where is the money going'],
    relatedMetrics: ['total_expenses', 'net_income'],
    requiresDimensions: ['gl_account'],
  },
];

// ── Accounting Metric-Dimension Relations ─────────────────────────

export const ACCT_METRIC_DIMENSIONS: MetricDimensionRelation[] = [
  // total_revenue
  { metricSlug: 'total_revenue', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 1 },
  { metricSlug: 'total_revenue', dimensionSlug: 'gl_account', isRequired: false, isDefault: false, sortOrder: 2 },
  { metricSlug: 'total_revenue', dimensionSlug: 'gl_classification', isRequired: false, isDefault: false, sortOrder: 3 },
  // total_expenses
  { metricSlug: 'total_expenses', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 1 },
  { metricSlug: 'total_expenses', dimensionSlug: 'gl_account', isRequired: false, isDefault: false, sortOrder: 2 },
  { metricSlug: 'total_expenses', dimensionSlug: 'gl_classification', isRequired: false, isDefault: false, sortOrder: 3 },
  // net_income
  { metricSlug: 'net_income', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 1 },
  // gl_entry_count
  { metricSlug: 'gl_entry_count', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 1 },
  // ap_outstanding
  { metricSlug: 'ap_outstanding', dimensionSlug: 'vendor', isRequired: false, isDefault: true, sortOrder: 1 },
  { metricSlug: 'ap_outstanding', dimensionSlug: 'ap_status', isRequired: false, isDefault: false, sortOrder: 2 },
  // ar_outstanding
  { metricSlug: 'ar_outstanding', dimensionSlug: 'ar_status', isRequired: false, isDefault: false, sortOrder: 1 },
  // ap_overdue
  { metricSlug: 'ap_overdue', dimensionSlug: 'vendor', isRequired: false, isDefault: true, sortOrder: 1 },
  // ar_overdue — no dimensions needed (simple aggregate)
  // cash_position
  { metricSlug: 'cash_position', dimensionSlug: 'gl_account', isRequired: false, isDefault: true, sortOrder: 1 },
  // trial_balance_total
  { metricSlug: 'trial_balance_total', dimensionSlug: 'gl_account', isRequired: false, isDefault: true, sortOrder: 1 },
  { metricSlug: 'trial_balance_total', dimensionSlug: 'gl_classification', isRequired: false, isDefault: false, sortOrder: 2 },
  // unmapped_event_count — no dimensions (simple count)
  // ap_bill_count
  { metricSlug: 'ap_bill_count', dimensionSlug: 'vendor', isRequired: false, isDefault: false, sortOrder: 1 },
  { metricSlug: 'ap_bill_count', dimensionSlug: 'ap_status', isRequired: false, isDefault: true, sortOrder: 2 },
  // ar_invoice_count
  { metricSlug: 'ar_invoice_count', dimensionSlug: 'ar_status', isRequired: false, isDefault: true, sortOrder: 1 },
  // gross_profit
  { metricSlug: 'gross_profit', dimensionSlug: 'date', isRequired: false, isDefault: true, sortOrder: 1 },
  // expense_by_category
  { metricSlug: 'expense_by_category', dimensionSlug: 'gl_account', isRequired: true, isDefault: true, sortOrder: 1 },
  { metricSlug: 'expense_by_category', dimensionSlug: 'date', isRequired: false, isDefault: false, sortOrder: 2 },
];

// ── Accounting System Lenses ──────────────────────────────────────

export const ACCT_SYSTEM_LENSES: Omit<LensDef, 'isActive'>[] = [
  {
    slug: 'accounting',
    displayName: 'Accounting',
    description:
      'General ledger, financial reports, accounts payable, accounts receivable, trial balance, balance sheet, P&L, and cash position. Use this lens for any GL, AP, AR, or financial reporting questions.',
    domain: 'accounting',
    isSystem: true,
    allowedMetrics: [
      'total_revenue',
      'total_expenses',
      'net_income',
      'gl_entry_count',
      'ap_outstanding',
      'ar_outstanding',
      'ap_overdue',
      'ar_overdue',
      'cash_position',
      'trial_balance_total',
      'unmapped_event_count',
      'ap_bill_count',
      'ar_invoice_count',
      'gross_profit',
      'expense_by_category',
    ],
    allowedDimensions: ['date', 'gl_account', 'gl_classification', 'vendor', 'ap_status', 'ar_status'],
    defaultMetrics: ['net_income', 'total_revenue', 'total_expenses'],
    defaultDimensions: ['date'],
    exampleQuestions: [
      'What is our net income this month?',
      'Show me the trial balance',
      'How much do we owe vendors?',
      'What is our cash position?',
      'P&L for last month',
      'AP aging report',
      'AR outstanding by status',
      'What are our biggest expenses?',
    ],
    systemPromptFragment:
      'You are analyzing accounting and financial data. GL amounts are in dollars (NUMERIC), not cents. For balance queries, always filter je.status = \'posted\'. Balance direction depends on normal_balance: assets/expenses = SUM(debit) - SUM(credit), liabilities/equity/revenue = SUM(credit) - SUM(debit). AP dates (bill_date, due_date) are TEXT — use ::date cast for date arithmetic. AR dates are DATE (no cast needed). Outstanding AP/AR = status IN (\'posted\', \'partial\') AND balance_due > 0. For trial balance, group by account and show both debit and credit totals. For P&L, filter revenue + expense accounts by date range. For balance sheet, show cumulative balances as-of a date.',
  },
];
